<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OpenVibeCode — Prompt / Raw HTML Preview</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=terminal" />

<style>
  :root{
    --dark-bg:#0A0F1D;
    --electric-blue:#4A90E2;
    --teal:#00C9B2;
    --magenta:#FF6B6B;
    --glass-bg: rgba(255,255,255,0.05);
    --glass-border: rgba(255,255,255,0.10);
    --radius:14px;
    --gap:16px;
    --transition: all 0.28s cubic-bezier(0.16,0.86,0.44,1.08);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    background: #071022;
    color:#edf7ff;
    min-height:100vh;
    display:flex;
    flex-direction:column;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* background layers (same as before) */
  .bg-layers{ position:fixed; inset:0; z-index:-3; pointer-events:none; }
  .bg-layers .layer{ position:absolute; filter: blur(92px); mix-blend-mode:screen; opacity:0.95; }
  .bg-layers .g1{ left:-12%; top:-18%; width:70%; height:70%; background: radial-gradient(circle at 30% 30%, var(--electric-blue) 0%, rgba(74,144,226,0.75) 18%, transparent 60%); transform:scale(1.08); }
  .bg-layers .g2{ right:-8%; top:18%; width:68%; height:72%; background: radial-gradient(circle at 70% 40%, var(--teal) 0%, rgba(0,201,178,0.78) 18%, transparent 65%); transform:scale(1.03); }
  .bg-layers .g3{ left:8%; bottom:-22%; width:70%; height:70%; background: radial-gradient(circle at 40% 80%, var(--magenta) 0%, rgba(255,107,107,0.8) 16%, transparent 62%); transform:scale(1.04); }

  .floating-lights{ position:fixed; inset:0; z-index:-2; pointer-events:none; }
  .light{ position:absolute; width:8px; height:8px; border-radius:50%; background:var(--magenta); opacity:0.8; filter: blur(0.3px); animation: float 28s infinite ease-in-out; }
  @keyframes float { 0%{transform:translateY(0)}50%{transform:translateY(-28px)}100%{transform:translateY(0)} }

  header{
    display:flex; align-items:center; justify-content:space-between; gap:var(--gap);
    padding:14px 20px; z-index:2; position:relative;
    backdrop-filter: blur(8px);
    background: linear-gradient(to bottom, rgba(255,255,255,0.02), transparent);
    border-bottom:1px solid rgba(255,255,255,0.03);
  }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; background:linear-gradient(135deg,var(--electric-blue),var(--teal)); box-shadow:0 8px 24px rgba(74,144,226,0.16); }
  .title{ font-weight:700; font-size:1rem }
  .meta{ color:#bcd9f8; font-size:0.85rem }
  .links a{ color:#eaf6ff; text-decoration:none; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02) }
  .links a:hover{ transform:translateY(-3px); box-shadow:0 6px 20px rgba(74,144,226,0.08) }

  /* main must participate in height chain */
  main{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:26px;
    padding:26px;
    width:100%;
    max-width:100%;
    margin:0 auto;
    flex:1 1 auto;     /* important so main grows */
    min-height:0;      /* allow children to shrink correctly */
  }

  .panel{ background:var(--glass-bg); border-radius:14px; border:1px solid var(--glass-border); padding:14px; display:flex; flex-direction:column; gap:12px; box-shadow: 0 12px 32px rgba(2,6,20,0.6); min-height:0; }
  label{ color:#cfe7ff; font-weight:600 }
  .controls-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .segmented{ display:inline-flex; background:rgba(255,255,255,0.02); border-radius:10px; padding:4px; border:1px solid rgba(255,255,255,0.03); }
  .segmented button{ background:transparent; color:#dff2ff; border:0; padding:8px 12px; cursor:pointer; border-radius:8px; font-weight:600; }
  .segmented button.active{ background: linear-gradient(90deg,var(--electric-blue),var(--teal)); box-shadow:0 8px 22px rgba(74,144,226,0.16); color:white; }

  /* generic textarea styling (no height) */
  textarea {
    width:100%;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color:#eaf4ff;
    padding:12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
    font-size:14px;
    line-height:1.6;
    resize: vertical;
    min-height: 64px;
    overflow:auto;
  }

  /* both textareas should have exactly same properties and stretch the same */
  .editor-textarea {
    flex: 1 1 auto;   /* stretch to fill available space */
    min-height: 0;    /* allow flexbox to control height */
    resize: vertical;
    overflow:auto;
    background: rgba(255,255,255,0.03);
  }

  /* small differences: visual min sizes */
  #promptEditor { min-height:36vh; }
  #htmlInput   { min-height:36vh; } /* match promptEditor exactly */

  .hidden { display:none !important; }

  .small{ font-size:0.85rem; color:#9fb7d9 }

  /* preview column participates in height chain */
  .preview-panel { display:flex; flex-direction:column; flex:1 1 auto; min-height:0; }

  /* ensure the inner .panel inside preview stretches fully */
  .preview-panel > .panel { display:flex; flex-direction:column; flex:1 1 auto; min-height:0; padding:10px; }

  .preview-top{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 6px; }
  .preview-actions{ display:flex; gap:8px; align-items:center }
  .btn{ border:0; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
  .btn.primary{ background:linear-gradient(90deg,var(--electric-blue),var(--teal)); color:white; box-shadow:0 10px 30px rgba(74,144,226,0.14) }
  .btn.ghost{ background:transparent; color:#d6efff; border:1px solid rgba(255,255,255,0.03) }

  /* iframe wrapper must stretch and allow iframe to fill */
  .iframe-wrap {
    position: relative;
    background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border-radius: 12px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    min-height: 0;
    width: 100%;
    overflow: hidden; /* avoid double scrollbars */
  }

  .iframe-wrap.generating iframe { filter: blur(6px) brightness(0.9); transform: scale(0.995); pointer-events: none; transition: filter 0.28s ease, transform 0.28s ease; }
  .generating-overlay{ display:none; position:absolute; inset:10px; border-radius:10px; z-index:8; background: linear-gradient(180deg, rgba(10,16,25,0.55), rgba(4,8,12,0.55)); backdrop-filter: blur(4px); align-items:center; justify-content:center; }
  .iframe-wrap.generating .generating-overlay{ display:flex; pointer-events:auto; }

  .gen-spinner {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(74, 144, 226, 0.08);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
}

.gen-spinner::before,
.gen-spinner::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  border: 4px solid transparent;
  border-top-color: var(--electric-blue);
  border-bottom-color: var(--teal);
}

.gen-spinner::before {
  width: 100%;
  height: 100%;
  animation: spin 1.2s linear infinite;
}

.gen-spinner::after {
  width: 70%;
  height: 70%;
  animation: spin 0.8s linear reverse infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
  .gen-label{ margin-top:12px;color:#d6efff;font-weight:600;font-size:14px;text-align:center;opacity:0.95; }

  /* iframe stretches to fill the iframe-wrap */
  iframe#preview {
    flex: 1 1 auto;
    width: 100%;
    min-height: 0;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    box-shadow: 0 12px 32px rgba(2,6,20,0.6);
  }

  @media (max-width:960px){
    main{ grid-template-columns: 1fr; padding:18px; }
    #promptEditor{ min-height:40vh }
    #htmlInput{ min-height:40vh }
    .iframe-wrap{ height:44vh }
  }
  
  .generating-overlay {
  display: none;
  position: absolute;
  inset: 0;               /* top:0; right:0; bottom:0; left:0 */
  border-radius: 10px;
  z-index: 8;
  background: linear-gradient(180deg, rgba(10,16,25,0.55), rgba(4,8,12,0.55));
  backdrop-filter: blur(4px);

            /* flex centering */
  align-items: center;    /* vertical center */
  justify-content: center;/* horizontal center */
}
.generating-overlay > div {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
  .logo { display:flex; align-items:center; justify-content:center; width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--electric-blue),var(--teal)); color:#fff; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; }
</style>
</head>
<body class="multi-gradient">

  <div class="bg-layers" aria-hidden="true">
    <div class="layer g1"></div>
    <div class="layer g2"></div>
    <div class="layer g3"></div>
  </div>

  <div class="floating-lights" aria-hidden="true">
    <div class="light" style="top:12%; left:8%;"></div>
    <div class="light" style="top:28%; left:44%;"></div>
    <div class="light" style="top:62%; left:72%;"></div>
    <div class="light" style="top:22%; left:84%;"></div>
    <div class="light" style="top:52%; left:18%;"></div>
    <div class="light" style="top:78%; left:56%;"></div>
  </div>

  <header>
    <div class="brand">
      <div class="logo">
        <span class="material-symbols-outlined">terminal</span>
      </div>
      <div>
        <div class="title">OpenVibeCode</div>
        <div class="meta">AI-Powered Web Generation — Preview editor</div>
      </div>
    </div>

    <div class="links">
      <a href="https://github.com/Vxtzq/OpenVibeCode" target="_blank" rel="noopener"><i class="fab fa-github"></i>&nbsp;GitHub</a>
    </div>
  </header>

  <main>
    <!-- editor panel -->
    <section class="panel editor-panel" aria-labelledby="editor-label">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div>
          <label id="editor-label">Prompt / Raw HTML</label>
          <div class="small">Switch between Prompt and Raw HTML. Only the corresponding editor appears.</div>
        </div>

        <div class="controls-row">
          <div class="segmented" role="tablist" aria-label="mode">
            <button id="mode-prompt" class="active" role="tab" aria-selected="true">Prompt</button>
            <button id="mode-raw" role="tab" aria-selected="false">Raw HTML</button>
          </div>
        </div>
      </div>

      <!-- Prompt textarea (visible in Prompt mode) -->
      <textarea id="promptEditor" class="editor-textarea" spellcheck="false" placeholder="Write a natural-language prompt (what you want: layout, sections, colors, components...)."></textarea>

      <!-- Raw HTML textarea (visible in Raw HTML mode) -->
      <textarea id="htmlInput" class="editor-textarea hidden" spellcheck="false" placeholder="Edit or paste raw HTML here. When in Prompt mode, generated HTML will be placed here (even if hidden)"></textarea>

      <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
        <div style="display:flex; gap:8px;">
          <button id="generateBtn" class="btn primary" title="Generate HTML"><i class="fa fa-rocket"></i>&nbsp;Generate</button>
          <button id="sampleBtn" class="btn ghost" title="Insert a sample prompt/html">Sample</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>
        <div class="small">Prompt and Raw HTML are independent. Generation writes HTML into the Raw HTML editor.</div>
      </div>
    </section>

    <!-- preview panel -->
    <aside class="preview-panel">
      <div class="panel">
        <div class="preview-top">
          <div><strong>Live Preview</strong></div>
          <div class="preview-actions">
            <button id="download" class="btn primary" title="Download the currently rendered HTML"><i class="fa fa-download"></i>&nbsp;Download</button>
            <button id="openNew" class="btn ghost" title="Open preview in new tab"><i class="fa fa-external-link-alt"></i>&nbsp;Open</button>
          </div>
        </div>

        <div class="iframe-wrap" role="region" aria-live="polite">
          <iframe id="preview" sandbox="allow-forms allow-pointer-lock allow-scripts"></iframe>

          <!-- generating overlay -->
          <div class="generating-overlay" aria-hidden="true">
            <div style="text-align:center">
              <div class="gen-spinner" aria-hidden="true"></div>
              <div class="gen-label">Generating… your vibe</div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

<!-- ===== behavior script (keeps same IDs) ===== -->
<script>
(function(){
  const promptEditor = document.getElementById('promptEditor');
  const htmlInput = document.getElementById('htmlInput');
  const preview = document.getElementById('preview');
  const iframeWrap = document.querySelector('.iframe-wrap');
  const downloadBtn = document.getElementById('download');
  const openNewBtn = document.getElementById('openNew');
  const genBtn = document.getElementById('generateBtn');
  const sampleBtn = document.getElementById('sampleBtn');
  const clearBtn = document.getElementById('clearBtn');
  const modePromptBtn = document.getElementById('mode-prompt');
  const modeRawBtn = document.getElementById('mode-raw');

  let currentBlobUrl = null;
  let mode = 'prompt'; // 'prompt' | 'raw'

  function revokeCurrent(){
    if (currentBlobUrl){ try{ URL.revokeObjectURL(currentBlobUrl); }catch{} currentBlobUrl=null; }
  }

  function setGenerating(on=true){
    if (on){
      iframeWrap.classList.add('generating');
      genBtn.disabled = true; downloadBtn.disabled = true; openNewBtn.disabled = true;
      genBtn.dataset.origText = genBtn.innerHTML;
      genBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>&nbsp;Generating…';
      genBtn.classList.remove('primary');
    } else {
      iframeWrap.classList.remove('generating');
      genBtn.disabled = false; downloadBtn.disabled = false; openNewBtn.disabled = false;
      genBtn.innerHTML = genBtn.dataset.origText || '<i class="fa fa-rocket"></i>&nbsp;Generate';
      genBtn.classList.add('primary');
    }
  }

  function setMode(m){
    mode = m;
    if (mode === 'prompt'){
      modePromptBtn.classList.add('active'); modePromptBtn.setAttribute('aria-selected','true');
      modeRawBtn.classList.remove('active'); modeRawBtn.setAttribute('aria-selected','false');

      promptEditor.classList.remove('hidden');
      htmlInput.classList.add('hidden');

      promptEditor.focus();
    } else {
      modeRawBtn.classList.add('active'); modeRawBtn.setAttribute('aria-selected','true');
      modePromptBtn.classList.remove('active'); modePromptBtn.setAttribute('aria-selected','false');

      promptEditor.classList.add('hidden');
      htmlInput.classList.remove('hidden');

      htmlInput.focus();
    }
  }

  modePromptBtn.addEventListener('click', () => setMode('prompt'));
  modeRawBtn.addEventListener('click', () => setMode('raw'));

  // sample & clear behave on visible editor
  const samplePrompt = `Create a sleek one-page landing for a developer tool called "OpenVibeCode". Include: header with logo and nav, hero with headline and CTA, features 3-column section, and a footer. Minimal animations, modern gradient, dark theme.`;
  const sampleRawHtml = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Sample</title></head><body style="font-family:Inter,system-ui,Arial;background:#071022;color:#eaf4ff;padding:36px;"><header><h1>OpenVibeCode — Sample</h1></header><main><p>This is a simple sample HTML block to preview.</p></main><footer style="margin-top:28px;font-size:14px;color:#9fb7d9">Generated sample</footer></body></html>`;

  sampleBtn.addEventListener('click', () => {
    if (mode === 'prompt') promptEditor.value = samplePrompt;
    else htmlInput.value = sampleRawHtml;
    if (mode === 'prompt') promptEditor.focus(); else htmlInput.focus();
  });

  clearBtn.addEventListener('click', () => {
    if (mode === 'prompt') promptEditor.value = '';
    else htmlInput.value = '';
    if (mode === 'prompt') promptEditor.focus(); else htmlInput.focus();
  });

  // render HTML into iframe using htmlInput content
  function renderHtmlIntoPreview(html){
    if (!html) return;
    revokeCurrent();
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    currentBlobUrl = url;
    preview.setAttribute('sandbox', 'allow-forms allow-pointer-lock allow-scripts'); // adjust as needed
    setTimeout(()=> preview.src = url, 50);
  }

  // main generate handler
  async function generateHandler(){
    if (mode === 'prompt'){
      const prompt = promptEditor.value || '';
      if (!prompt.trim()){ alert('Please enter a prompt to generate HTML'); return; }

      setGenerating(true);
      try {
        const resp = await fetch('/generate', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt: prompt, strip_scripts: false })
        });
        if (!resp.ok){
          const err = await resp.json().catch(()=>({error:'server error'}));
          throw new Error(err.error || resp.statusText);
        }
        const data = await resp.json();
        const html = data.html || '';

        // Put generated HTML into the Raw HTML editor (htmlInput) then render
        htmlInput.value = html;
        renderHtmlIntoPreview(html);

        setGenerating(false);
        promptEditor.focus();
      } catch (err){
        console.error(err);
        alert('Generation failed: ' + (err.message || err));
        setGenerating(false);
        promptEditor.focus();
      }
    } else {
      // raw mode: render htmlInput directly
      const html = htmlInput.value || '';
      if (!html.trim()){ alert('Please paste raw HTML into the Raw HTML editor to render it.'); return; }
      setGenerating(true);
      try {
        renderHtmlIntoPreview(html);
        setTimeout(()=> setGenerating(false), 160);
      } catch (err){
        console.error(err);
        alert('Failed to render: ' + (err.message || err));
        setGenerating(false);
      }
    }
  }

  genBtn.addEventListener('click', generateHandler);

  // keyboard shortcut: Ctrl/Cmd + Enter triggers generate no matter which editor is focused
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      generateHandler();
    }
  });

  // download / open: always use htmlInput content
  downloadBtn.addEventListener('click', () => {
    const html = htmlInput.value || '';
    if (!html.trim()){ alert('Nothing to download — generate or paste HTML first.'); return; }
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'vibe-generated.html';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
  });

  openNewBtn.addEventListener('click', () => {
    if (currentBlobUrl) { window.open(currentBlobUrl, '_blank', 'noopener'); return; }
    const html = htmlInput.value || '';
    if (!html.trim()){ alert('No preview available yet.'); return; }
    const url = URL.createObjectURL(new Blob([html], {type:'text/html'}));
    window.open(url, '_blank', 'noopener');
    setTimeout(()=> URL.revokeObjectURL(url), 2000);
  });

  // initialize
  setMode('prompt');

})();
</script>
</body>
</html>
